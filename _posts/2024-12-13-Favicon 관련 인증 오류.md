---
title: favicon 관련 인증 오류
description: >-
  인증 오류 관련 정리.
author: dgkim
date: 2024-12-13 11:02:00 +0900
categories: [개발 일상]
tags: [springboot]
pin: false
media_subpath: '/assets/posts/20241213'
comments: true
math: true
mermaid: true
image:
  path: /commons/devices-mockup.png
  lqip: data:image/webp;base64,UklGRpoAAABXRUJQVlA4WAoAAAAQAAAADwAABwAAQUxQSDIAAAARL0AmbZurmr57yyIiqE8oiG0bejIYEQTgqiDA9vqnsUSI6H+oAERp2HZ65qP/VIAWAFZQOCBCAAAA8AEAnQEqEAAIAAVAfCWkAALp8sF8rgRgAP7o9FDvMCkMde9PK7euH5M1m6VWoDXf2FkP3BqV0ZYbO6NA/VFIAAAA
  alt: Responsive rendering of Chirpy theme on multiple devices.
---
# 인증 오류 이슈 해결
 몇일 전부터 고객사로 부터 인증 오류가 계속 보고 되었다. 해당 부분은 직접 관여한 적이
없어서, 나에게 테스트 환경 같은 것은 제대로 갖추어져 있지 않았다. 다른 일 때문에 바쁘
기도 했고 사실 하려고하면 할 수 있었지만 다른 개인적인 결정 때문에 미루었다.

## 문제 사항 개요
 사이트 로그인을 할 때 간혹 일부 사용자들이 로그인 직후 인증이 끊어지는 문제가 발생했다.
인증 서버에서 인증을 받고, 인증서버의 인증을 확인 후 사이트에서 인증 시도 할 때 발생
하는 문제였다.

## 사이트에 대한 구성.
### 인증 흐름
 인증 서버 업체에서 안내한 절차대로 인증을 진행하고 있다. 직접 개발한 것이 아니기에
일단 소스코드와 로그를 분석해서 확인한 사항이다. 그림에서 보면 인증서버가 따로 있는데
완전히 일치하지는 않지만 IDP라고 보면 적당하고 이쪽 사이트를 SP라고 보면 적당할 것 같다.
![light mode only](<인증흐름.jpg>){: .light .w-75 .shadow .rounded-10 w='1212' h='668' }

### 운영 구성
 앞단에 L4가 있다. 그리고 웹서버 두대가 L4 하위에 존재하고 있는 구조이다. 
![light mode only](<서버구성.jpg>){: .light .w-75 .shadow .rounded-10 w='1212' h='668' }

## 해결에 대해
최초에 연락을 받았을 때는 L4를 의심 했었다. 사이트 개발 당시에는 그다지 생각하지 않았
던 것이었다.

개발 당시 얘기를 잠깐하자면, 인증 관련해서 처리하시는 분이 작업을 완료하고
소스를 넘겨 주었는데.. 추가 기능을 개발 하라는 지시였다. 개인화된 대시보드, 개인 정보 탭
, 대시보드 개인화 설정 기능, 사용자 역할 별 기본 대시보드 설정, 사이트 내 게시판, 외부 사이트 
게시판, 외부 시스템인 결재, 대여, 메일 연동, 로그인 시나리오별 대응 비번 까먹었을 때
2차인증 걸었는데 폰 안가져왔을 때 그외 몇가지 기능, 관리자의 관리 기능...

문제는 개발 기간이 2주 정도였다. 일을 받은 과장님의 표정이 정말 대박이었다. 어째 하다
보니 내가 일을 받아와서, 정말 이틀 만에 스키마 그리고 프로젝트 구조를 나누어서, 
개발 중 기능을 서로 침범하지 않도록 배려 한다음 개발자 4명을 한번에 투입시켰다. 중간에 
조율이 필요하거나 공통된 기능은 내가 직접 작업해서 개발하시는 분들에게 안내 했다. 
정말 1~2주만에 뚝딱 해치웠던 그런 프로젝트 였다. 물론 사업기간은 여유가 있었지만, 
그걸 앞에서 많이 잡아먹었다는 것이 함정...

어째하다보니 내 업무가 아니었지만, 내가 주가 되어버린... 내꺼인듯 아닌듯... 그런 프로젝트

다시 돌아와서. L4는 몇가지 설정 방법이 있다. 효율을 위해서라면 사이트에서 SESSION을 공유
하는 방법을 따로 처리하거나 클라이언트에서 인증정보를 가지고 있도록 해서 웹서버를 무상태로
두어야 한다.

하지만 고객님에게 확인한 결과 Source Hash 였다. 일단 L4는 제외... 
그 이후로 의심한 것이 SSO 인증 로직 사이에서 뭔가 잘못된 경우였다. 그림은 간단하지만 
조금 절차가 있었다. 소스에 관련 로직에 로그를 추가하고 몇 일을 지켜 봤지만, 그것도 아니었다.

대체 뭘까? 안되면 직접 찾아가서 확인해보려던 때 메일이 왔다. 고객사에서 웹 개발 툴을
캡처해서 보내준 것이었다.

*** 요청-1 ***
- 요청 url : /login-process
- 요청 쿠키 : 3415BCD87AAF3B13E4F5BDE59C0C3020
- 응답 쿠키 : 2A9354F906B634EC11F339AC8D4B3AB8
- 쿠키 : "set cookie JSESSIONID=2A9354F906B634EC11F339AC8D4B3AB8; Path=/; Secure; HttpOnly"
- 상태 : 302

*** 요청-2 ***
- 요청 url : /favicon.ico
- 요청 쿠키 : 3415BCD87AAF3B13E4F5BDE59C0C3020
- 응답 쿠키 : 9EAC0AD736118E67D1F15B8931DEE96D
- 쿠키 : "set cookie JSESSIONID=9EAC0AD736118E67D1F15B8931DEE96D; Path=/; Secure; HttpOnly"
- 상태 : 404

*** 요청-3 ***
- 요청 url : 메인페이지 요청
- 요청 쿠키 : 2A9354F906B634EC11F339AC8D4B3AB8
- 쿠키 : "set cookie JSESSIONID=2A9354F906B634EC11F339AC8D4B3AB8; Path=/; Secure; HttpOnly"
- 상태 : 200

*** 요청-4 ***
- 요청 url : 외부 게시판 목록 요청
- 요청 쿠키 : 9EAC0AD736118E67D1F15B8931DEE96D
- 쿠키 : "set cookie JSESSIONID=9EAC0AD736118E67D1F15B8931DEE96D; Path=/; Secure; HttpOnly"
- 상태 : 401

이야.. 이런 경우가 있네... 세션이 바뀌는 것은 Session Fixation 공격을 예방하기 위한 것이라고
한다. 사실 별 관심이 없어서 잘 몰랐던 부분이다. 그렇다면 세션이 바뀌는 것은 자연스러우나
/favicon 이 문제였다. ajax 요청에서 401이 나타나면 인증 오류 메세지와 함께 로그인 페이지로
리디렉션 되도록 처리되어 있다.

사이트의 favicon의 위치는 저 위치가 아니다. 일단 대응은 favicon.ico 위치를 springboot에서
인증 예외로 두었고, 중간에 로그인 시도전에 잠깐 뜨는 화면이 있는데 거기에 favicon을 명시하지
않은 것을 확인하고 추가를 해주었다.

이 방법이 안되었다면 아마 직접 가서 확인하면서 대응 해야 할 것 같다. 몇가지 대응 방안이
있으나 이슈가 발생한지 시간이 조금 흐르기도 했고, 가서 직접해보면서 처리하는 것이 나을 것
같다. 그런데 지금 프로젝트 진행하면서 몸을 빼기가 쉽지가 않을 것 같기도 하다...

